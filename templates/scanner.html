<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Boarding Pass Scanner</title>
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    window.addEventListener('DOMContentLoaded', () => {
      const codeReader = new BrowserMultiFormatReader();
      const videoElement = document.getElementById('video');
      const form = document.getElementById('passenger-form');
      const questionInput = document.getElementById('question');

      function parseBoardingPass(data) {
        console.log("📦 Raw scan:", data);

        const nameMatch = data.match(/^M1([A-Z]+)\/([A-Z]+)/);
        const flightMatch = data.match(/([A-Z]{2}\d{3,4})/);
        const gateMatch = data.match(/([A-Z]\d{2})/);
        const timeMatch = data.match(/(\d{4})$/);

        const name = nameMatch ? `${nameMatch[2]} ${nameMatch[1]}` : "Passenger";
        const flight = flightMatch ? flightMatch[1] : "Unknown Flight";
        const gate = gateMatch ? gateMatch[1] : "Unknown Gate";
        const time = timeMatch ? `${timeMatch[1].slice(0,2)}:${timeMatch[1].slice(2)}` : "Unknown Time";

        console.log("👤 Name:", name);
        console.log("✈️ Flight:", flight);
        console.log("🛫 Gate:", gate);
        console.log("⏰ Boarding Time:", time);

        return { name, flight, gate, time };
      }


    codeReader.decodeFromVideoDevice(null, videoElement, (result, error, controls) => {
      if (result) {
        const raw = result.getText();
        const info = parseBoardingPass(raw);
        console.log("🧪 Final Info:", info);

        const message = `Hi, I'm ${info.name}. My flight is ${info.flight} from gate ${info.gate} at ${info.time}.`;
        console.log("📨 Final Message:", message);
        questionInput.value = message;

        controls.stop();
        form.submit();
      }
    });
   });
  </script>
  <style>
    body { font-family: Arial; text-align: center; padding: 20px; }
    video { width: 100%; max-width: 500px; border: 2px solid #ccc; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Scan Your Boarding Pass</h1>
  <video id="video" autoplay></video>

  <form id="passenger-form" method="POST" action="/">
    <input type="hidden" id="question" name="question">
  </form>
</body>

</html>
